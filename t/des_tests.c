#include "t.h"
#include "test_groups.h"
#include "des.h"

static int subkeys()
{
	uint64_t	key = 0x133457799BBCDFF1;
	uint64_t	subkeys[16];
	uint64_t	expected[16] = {
		0b0001101100000010111011111111110001110000011100100000000000000000,
		0b0111100110101110110110011101101111001001111001010000000000000000,
		0b0101010111111100100010100100001011001111100110010000000000000000,
		0b0111001010101101110101101101101100110101000111010000000000000000,
		0b0111110011101100000001111110101101010011101010000000000000000000,
		0b0110001110100101001111100101000001111011001011110000000000000000,
		0b1110110010000100101101111111011000011000101111000000000000000000,
		0b1111011110001010001110101100000100111011111110110000000000000000,
		0b1110000011011011111010111110110111100111100000010000000000000000,
		0b1011000111110011010001111011101001000110010011110000000000000000,
		0b0010000101011111110100111101111011010011100001100000000000000000,
		0b0111010101110001111101011001010001100111111010010000000000000000,
		0b1001011111000101110100011111101010111010010000010000000000000000,
		0b0101111101000011101101111111001011100111001110100000000000000000,
		0b1011111110010001100011010011110100111111000010100000000000000000,
		0b1100101100111101100010110000111000010111111101010000000000000000
	};

	generate_subkeys(key, subkeys);
	for (int i = 0; i < 16; i++) 
	{
		if (subkeys[i] != expected[i])
			return (1);
	}
	return (0);
}

static int	initial_permutation()
{
	uint64_t	m = 0b0000000100100011010001010110011110001001101010111100110111101111;
	uint64_t	expected = 0b1100110000000000110011001111111111110000101010101111000010101010;
	
	uint64_t res = apply_ip(m);
	if (res != expected)
		return (1);
	return (0);
}

static int	expansion()
{
	uint64_t	m = 0b11110000101010101111000010101010L << 32;
	uint64_t	expected = 0b011110100001010101010101011110100001010101010101 << 16;

	uint64_t	res = expand(m);
	if (res != expected)
		return (1);
	return (0);
}

static int	substitution()
{
	uint64_t	m = 0b011000010001011110111010100001100110010100100111 << 16;
	uint64_t	expected = 0b01011100100000101011010110010111L << 32;

	uint64_t	res = substitude(m);
	if (res != expected)
		return (1);
	return (0);
}

static int	round_permutation()
{
	uint64_t	m = 0b01011100100000101011010110010111L << 32;
	uint64_t	expected = 0b00100011010010101010100110111011L << 32;

	uint64_t	res = permute(m);
	if (res != expected)
		return (1);
	return (0);
}

static int	final_permutation()
{
	uint64_t	m = 0b0000101001001100110110011001010101000011010000100011001000110100;
	uint64_t	expected = 0b1000010111101000000100110101010000001111000010101011010000000101;
	
	uint64_t res = apply_fp(m);
	if (res != expected)
		return (1);
	return (0);
}

static int	block_encryption()
{
	t_byte		message[] = {0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF};
	t_byte		expected[] = {0x85, 0xE8, 0x13, 0x54, 0x0F, 0x0A, 0xB4, 0x05};
	t_byte		output[8];
	uint64_t	key = 0x133457799BBCDFF1;
	uint64_t	subkeys[16];

	generate_subkeys(key, subkeys);
	des_core(subkeys, message, output);
	for (int i = 0; i < 8; i++)
		if (output[i] != expected[i])
			return (1);
	return (0);
}

int	des_tests()
{
	RUN_TEST(subkeys);
	RUN_TEST(initial_permutation);
	RUN_TEST(expansion);
	RUN_TEST(substitution);
	RUN_TEST(round_permutation);
	RUN_TEST(final_permutation);
	RUN_TEST(block_encryption);
	return (0);
}
